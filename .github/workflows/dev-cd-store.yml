#name: dev-cd-store.yml
#on:
#  push:
#    branches: [ dev ]
#    paths:
#      - 'config/common.yml'
#      - 'config/kafka-topics.yml'
#      - 'config/spot-store.yml'
#      - 'spot-store/src/main/**'
#      - '.github/workflows/dev-cd-store.yml'
#
#env:
#  SPRING_JWT_SECRET: ${{ secrets.SPRING_JWT_SECRET }}
#  TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
#  TOSS_CUSTOMER_KEY: ${{ secrets.TOSS_CUSTOMER_KEY }}
#  SERVICE_NAME: store-task
#  AWS_REGION: ap-northeast-2
#  ECR_REPOSITORY: spot-store
#  ECS_SERVICE: spot-store-service
#  ECS_CLUSTER: spot-dev-cluster
#
#jobs:
#  deploy:
#    name: Deploy to ECS DEV Cluster
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: spot-store
#    permissions:
#      id-token: write
#      contents: read
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 21
#        uses: actions/setup-java@v4
#        with:
#          java-version: '21'
#          distribution: 'temurin'
#          cache: gradle
#
#      - name: Grant execute permission for gradlew
#        run: chmod +x gradlew
#
#      - name: Build with Gradle
#        run: ./gradlew build -x test
#
#      # AWS OIDC 인증
#      - name: configure aws
#        id: aws-config
#        uses: aws-actions/configure-aws-credentials@v4
#        with:
#          aws-region: ${{ env.AWS_REGION }}
#          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
#
#      # ECR 로그인
#      - name: Login to ECR
#        id: login-ecr
#        uses: aws-actions/amazon-ecr-login@v2
#
#      # Git SHA 이미지 태그
#      - name: Get Image Tag
#        id: image-tag
#        run: echo "short_tag=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
#
#      # Docker 이미지 빌드
#      - name: Build Docker Image
#        id: docker-build
#        env:
#          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#          IMAGE_TAG: ${{ steps.image-tag.outputs.short_tag }}
#        run: |
#          docker build \
#          -t  $REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
#          -f Dockerfile .
#
#      # ECR Push
#      - name: Push Docker Image To ECR
#        id: docker-push
#        env:
#          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#          IMAGE_TAG: ${{ steps.image-tag.outputs.short_tag }}
#        run: |
#          docker push $REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#
#      # Task Definition 랜더링 작업
#      - name: Render Task Definition
#        id: render-task-def
#        env:
#          NEW_IMAGE: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.short_tag }}
#          SERVICE_NAME: ${{ env.SERVICE_NAME }}
#          AWS_REGION: ${{ env.AWS_REGION }}
#        run: |
#          echo "Rendering Task Definition..."
#
#          # 1. 필요한 필드만 가져오기 (family, cpu, memory, role 등 필수값 포함)
#          aws ecs describe-task-definition \
#            --task-definition "spot-dev-$SERVICE_NAME" \
#            --region "$AWS_REGION" \
#            --query '{
#              family: taskDefinition.family,
#              cpu: taskDefinition.cpu,
#              memory: taskDefinition.memory,
#              networkMode: taskDefinition.networkMode,
#              executionRoleArn: taskDefinition.executionRoleArn,
#              taskRoleArn: taskDefinition.taskRoleArn,
#              containerDefinitions: taskDefinition.containerDefinitions,
#              volumes: taskDefinition.volumes,
#              placementConstraints: taskDefinition.placementConstraints,
#              requiresCompatibilities: taskDefinition.requiresCompatibilities
#            }' \
#            --output json > raw-task-def.json
#
#          # 로컬 파일을 읽어서, 이미지 태그만 'NEW_IMAGE'로 교체 후 저장
#          jq --arg IMAGE "$NEW_IMAGE" '.containerDefinitions[0].image = $IMAGE' raw-task-def.json > new-task-def.json
#
#          # 디버깅용 확인
#          echo "=== NEW Task Definition Preview ==="
#          cat new-task-def.json
#
#          # AWS에 등록
#          NEW_TASK_INFO=$(aws ecs register-task-definition --cli-input-json file://new-task-def.json)
#
#          # ARN 추출
#          NEW_TASK_ARN=$(echo $NEW_TASK_INFO | jq -r '.taskDefinition.taskDefinitionArn')
#          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_OUTPUT
#          echo "New Task Definition ARN: $NEW_TASK_ARN"
#
#      # 서비스 업데이트
#      - name: Update Service
#        id: update-service
#        run: |
#          echo "Updating ECS Service..."
#
#          aws ecs update-service \
#            --cluster ${{ env.ECS_CLUSTER }} \
#            --service ${{ env.ECS_SERVICE }} \
#            --task-definition ${{ steps.render-task-def.outputs.NEW_TASK_ARN }} \
#            --force-new-deployment
#
#      # 서버 부팅 확인
#      - name: Wait Service
#        id: wait-service
#        run: |
#          echo "Wait For Boot Service"
#          aws ecs wait services-stable \
#          --cluster ${{ env.ECS_CLUSTER }} \
#          --service ${{ env.ECS_SERVICE }}
#
#      # Discord 알림 - 성공
#      - name: Notify Discord - Dev CD SUCCESS
#        run: |
#          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
#            -H "Content-Type: application/json" \
#            -d '{
#              "embeds": [{
#                "title": "✅ DEV CD 성공 - Store",
#                "description": "**설명**\n- 배포 성공\n\n**이미지**\n- ${{ steps.image-tag.outputs.short_tag }}",
#                "color": 3066993
#                }]
#            }'
#
#      # Discord 알림 - 실패
#      - name: Notify Discord - DEV CD FAIL
#        if: failure()  # 앞 단계 중 하나라도 실패하면 실행됨
#        run: |
#          # ---------------------------------------------------------
#          # 1. 실패 원인 찾기 (이 로직은 그대로 유지해야 함!)
#          # ---------------------------------------------------------
#          FAILED_STEP="알 수 없음"
#
#          if [ "${{ steps.aws-config.outcome }}" == "failure" ]; then FAILED_STEP="AWS 인증"; fi
#          if [ "${{ steps.login-ecr.outcome }}" == "failure" ]; then FAILED_STEP="ECR 로그인"; fi
#          if [ "${{ steps.docker-build.outcome }}" == "failure" ]; then FAILED_STEP="Docker 이미지 빌드"; fi
#          if [ "${{ steps.docker-push.outcome }}" == "failure" ]; then FAILED_STEP="ECR Push"; fi
#          if [ "${{ steps.render-task-def.outcome }}" == "failure" ]; then FAILED_STEP="Task Definition 교체"; fi
#          if [ "${{ steps.update-service.outcome }}" == "failure" ]; then FAILED_STEP="ECS 서비스 업데이트"; fi
#          if [ "${{ steps.wait-service.outcome }}" == "failure" ]; then FAILED_STEP="서비스 부팅"; fi
#
#          DISCORD_PAYLOAD=$(jq -n \
#            --arg step "$FAILED_STEP" \
#            --arg tag "${{ steps.image-tag.outputs.short_tag }}" \
#            '{
#              embeds: [{
#                title: "❌ DEV CD 실패 - Store",
#                description: ("**원인**\n - " + $step + " 실패\n**태그**\n - `" + $tag + "`"),
#                color: 15158332
#              }]
#            }')
#
#          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
#            -H "Content-Type: application/json" \
#            -d "$DISCORD_PAYLOAD"
