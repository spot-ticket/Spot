name: DEV PR Check - Order Service

on:
  pull_request:
    branches: [ dev ]
    paths:
      #        - 'infra/client/**'
      - 'spot-order/**'
      - '.github/workflows/pr-check-order.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spot-order

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: myapp_db
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      #        cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Make application.properties
        env:
          COMMON_YML: ${{ secrets.DEV_COMMON_YML }}
        run: |
          mkdir -p ./src/main/resources
          echo "$COMMON_YML" > ./src/main/resources/common-application.yml
          cp ../config/spot-order.yml ./src/main/resources/application.yml
        shell: bash

      - name: Debug - Check Configuration Files
        run: |
          echo "=== File List ==="
          ls -al ./src/main/resources/
          
          echo "=== Common YML Content ==="
          cat ./src/main/resources/common-application.yml
          
          echo "=== Application YML Content ==="
          cat ./src/main/resources/application.yml

      # Kafka & Zookeeper 수동 실행 (docker run)
      - name: Start Kafka & Zookeeper
        run: |
          echo "Starting Zookeeper..."
          docker run -d --name zookeeper -p 2181:2181 -e ZOOKEEPER_CLIENT_PORT=2181 confluentinc/cp-zookeeper:7.5.0
          
          echo "Waiting for Zookeeper..."
          sleep 5
          
          echo "Starting Kafka..."
          # --link zookeeper:zookeeper 옵션으로 컨테이너끼리 연결
          # ADVERTISED_LISTENERS에 localhost:9092를 명시하여 외부(CI Runner) 접속 허용
          docker run -d --name kafka \
            -p 9092:9092 \
            --link zookeeper:zookeeper \
            -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
            -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
            -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
            confluentinc/cp-kafka:7.5.0

      # Kafka 켜질 때까지 대기
      - name: Wait for Kafka to be ready
        run: |
          echo "Waiting for Kafka to be ready on localhost:9092..."
          for i in {1..30}; do
            if nc -z localhost 9092; then
              echo "✅ Kafka is up and running!"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          echo "❌ Kafka failed to start."
          docker logs kafka
          exit 1

      - name: Check code formatting
        run: ./gradlew checkstyleMain

      - name: Run tests
        run: ./gradlew test
        continue-on-error: true

      - name: Build with Gradle
        run: ./gradlew bootJar -x test

      - name: Test application startup
        run: |
          # 1. 빌드된 JAR 파일 찾기
               JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)
               echo "Testing JAR: $JAR_FILE"
          
          # 백그라운드 실행
               nohup java -Dspring.output.ansi.enabled=NEVER \
                  -jar $JAR_FILE \
                  --management.endpoint.health.show-details=always > app.log 2>&1 &
          
               APP_PID=$!
               echo "Started JAR with PID: $APP_PID"
          
          # 최대 60초 대기하면서 애플리케이션 시작 확인
          echo "Waiting for application to start..."
          
          for i in {1..60}; do
            # 서버 헬스 체크
            RESPONSE=$(curl -s -f http://localhost:8084/actuator/health || true)
            if  [[ "$RESPONSE" == *"UP"* ]]; then
              echo "✅ Application started successfully after ${i}s"
              kill $APP_PID 2>/dev/null || true
              exit 0
            fi
          
              # 헬스 체크 응답 결과 출력
              echo "=== Actuator Health Response ==="
              echo "$RESPONSE" | jq .
              echo "=================================="
          
            # 프로세스가 중간에 죽었는지 체크
            if ! kill -0 $APP_PID 2>/dev/null; then
               echo "❌ Application process died unexpectedly"
               cat app.log
               exit 1
            fi
          
          # 디버깅: 왜 실패하는지 확인
            if [ $((i % 10)) -eq 0 ]; then
               echo "⏳ Waiting... ($i/60s)"
               echo "Last curl response: $RESPONSE"
               # 연결 자체가 안되는지, 401 에러인지 확인하기 위해 상태 코드만 찍어봄
               curl -s -o /dev/null -w "%{http_code}" http://localhost:8084/actuator/health || echo "Connection Refused"
               echo "" 
            fi
          
            sleep 1
          done

          echo "❌ Application failed to start within 60s"
          cat app.log
          kill $APP_PID 2>/dev/null || true
          exit 1
        shell: bash

      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            build/reports/
            build/test-results/
