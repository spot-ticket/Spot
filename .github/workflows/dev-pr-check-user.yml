name: DEV PR Check - User Service

on:
  pull_request:
    branches: [ dev ]
    paths:
      - 'config/common.yml'
      - 'config/kafka-topics.yml'
      - 'config/spot-user.yml'
      - 'spot-user/**'
      - '.github/workflows/dev-pr-check-user.yml'

env:
  SPRING_JWT_SECRET: ${{ secrets.SPRING_JWT_SECRET }}
  EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
  TOSS_CUSTOMER_KEY: ${{ secrets.TOSS_CUSTOMER_KEY }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spot-user

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: myapp_db
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      kafka:
        image: confluentinc/cp-kafka:7.5.0
        ports:
          - 9092:9092
        env:
          KAFKA_LOG4J_ROOT_LOGLEVEL: 'WARN'
          KAFKA_LOG4J_LOGGERS: 'kafka.controller=WARN,state.change.logger=WARN,kafka.producer.async.DefaultEventHandler=WARN'

          KAFKA_NODE_ID: 1
          KAFKA_PROCESS_ROLES: 'broker,controller'
          KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:29093'
          KAFKA_LISTENERS: 'PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093'

          KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://localhost:9092'

          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT'
          KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
          KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

          CLUSTER_ID: 'J9Xz7kQPRYyK8VkqH3mW5A'

          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

        options: >-
          --health-cmd "kafka-topics --bootstrap-server localhost:9092 --list"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

#      - name: Make application.properties
#        run: |
#          mkdir -p ./src/main/resources
#          echo "Copying config files..."
#          cp ../config/common.yml ./src/main/resources/common.yml
#          cp ../config/kafka-topics.yml ./src/main/resources/kafka-topics.yml
#          cp ../config/spot-user.yml ./src/main/resources/application.yml
#        shell: bash

#      - name: Debug - Check Configuration Files
#        run: |
#          echo "=== File List ==="
#          ls -al ./src/main/resources/
#
#          echo "=== Common YML Content ==="
#          cat ./src/main/resources/common.yml
#
#          echo "=== Kafka Topics YML Content ==="
#          cat ./src/main/resources/kafka-topics.yml
#
#          echo "=== Application YML Content ==="
#          cat ./src/main/resources/application.yml

      - name: Check code formatting
        run: ./gradlew checkstyleMain

      - name: Run tests
        run: ./gradlew test
        continue-on-error: true

      - name: Build with Gradle
        run: ./gradlew bootJar -x test

      - name: Test application startup
        run: |
          # 빌드된 JAR 파일 찾기
          JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)
          echo "Testing JAR: $JAR_FILE"
          
          # 백그라운드 실행
          nohup java -Dspring.output.ansi.enabled=NEVER \
              -jar $JAR_FILE \
              --management.endpoint.health.show-details=always > app.log 2>&1 &
          
          APP_PID=$!
          echo "Started JAR with PID: $APP_PID"
          
          # 최대 60초 대기하면서 애플리케이션 시작 확인
          echo "Waiting for application to start..."
          
          for i in {1..60}; do
            # 서버 헬스 체크
            RESPONSE=$(curl -s -f http://localhost:8081/actuator/health || true)
            if  [[ "$RESPONSE" == *"UP"* ]]; then
              echo "✅ Application started successfully after ${i}s"
              kill $APP_PID 2>/dev/null || true
              exit 0
            fi
          
              # 헬스 체크 응답 결과 출력
              echo "=== Actuator Health Response ==="
              echo "$RESPONSE" | jq .
              echo "=================================="
          
            # 프로세스가 중간에 죽었는지 체크
            if ! kill -0 $APP_PID 2>/dev/null; then
               echo "❌ Application process died unexpectedly"
               cat app.log
               exit 1
            fi
          
          # 디버깅 - 실패 원인 찾기
            if [ $((i % 10)) -eq 0 ]; then
               echo "⏳ Waiting... ($i/60s)"
               echo "Last curl response: $RESPONSE"
               # 확인하기 위한 상태 코드
               curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health || echo "Connection Refused"
               echo "" 
            fi
          
            sleep 1
          done
          
          echo "❌ Application failed to start within 60s"
          cat app.log
          kill $APP_PID 2>/dev/null || true
          exit 1
        shell: bash

      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            build/reports/
            build/test-results/